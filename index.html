<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>মুক্তলিপি ডায়েরি - ২.০</title>

    <!-- PWA Manifest & Meta Tags -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#1877f2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="মনের কথা, মুক্ত ভাষায় - মুক্তলিপি ডায়েরি">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Galada&family=Hind+Siliguri:wght@300;400;500;600;700&family=Noto+Serif+Bengali:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --bg-color: #f4f7f6; 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --glass-blur: blur(20px);
            --text-color: #1c1e21; 
            --primary-color: #1877f2;
            --gradient-primary: linear-gradient(135deg, #1877f2 0%, #00c6ff 100%);
            --border-color: rgba(0,0,0,0.08); 
            --secondary-text: #65676b; 
            --content-font-size: 16px;
            --highlight-color: #fff3cd;
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.05);
            --shadow-card: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --current-font: 'Hind Siliguri', sans-serif;
            --sheet-bg: #ffffff;
            --transition-speed: 0.3s;
            --shimmer-bg: rgba(0,0,0,0.06);
            --shimmer-highlight: rgba(255,255,255,0.5);
        }
        .dark-theme { 
            --bg-color: #121212; 
            --glass-bg: rgba(30, 30, 30, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-color: #e4e6eb; 
            --primary-color: #4595ff; 
            --gradient-primary: linear-gradient(135deg, #4595ff 0%, #1877f2 100%);
            --border-color: rgba(255,255,255,0.1); 
            --secondary-text: #b0b3b8; 
            --highlight-color: #584c06;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --sheet-bg: #1e1e1e;
            --shimmer-bg: rgba(255,255,255,0.05);
            --shimmer-highlight: rgba(255,255,255,0.1);
        }

        body, .glass-panel, input, select, textarea, .nav-item, .post-card, .btn, .sheet-content {
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        body { font-family: var(--current-font); background: var(--bg-color); color: var(--text-color); margin: 0; padding: 0 0 100px 0; user-select: none; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            box-shadow: var(--shadow-card);
        }

        #readingProgress { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--gradient-primary); z-index: 9999; transition: width 0.1s; }
        .container { max-width: 800px; margin: 0 auto; padding: 70px 15px 10px 15px; min-height: 100vh;}

        /* --- Header Banner --- */
        .header-banner-container {
            width: 100%; height: 120px; border-radius: 15px; overflow: hidden; margin-bottom: 15px;
            position: relative; box-shadow: var(--shadow-soft);
        }
        .header-banner { width: 100%; height: 100%; object-fit: cover; }
        .banner-text {
            position: absolute; bottom: 10px; left: 15px; color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-weight: 700; font-size: 18px;
        }

        /* --- Dynamic Header & Stories --- */
        .greeting-section { margin-bottom: 15px; padding: 0 5px; }
        .greeting-text { font-size: 22px; font-weight: 700; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 8px; }
        .date-text { font-size: 13px; color: var(--secondary-text); margin-top: 2px; }

        /* --- Post Card & Masonry --- */
        .masonry-feed { column-count: 2; column-gap: 15px; }
        @media (max-width: 500px) { .masonry-feed { column-count: 1; } }
        
        .post-card { 
            break-inside: avoid; margin-bottom: 15px;
            display: inline-block; width: 100%;
            padding: 15px; border-radius: 20px; 
            position: relative; overflow: visible; 
            transform-origin: center center;
            box-sizing: border-box; cursor: pointer;
        }
        
        .admin-actions {
            position: absolute; top: 10px; right: 10px; z-index: 5;
            display: none; 
        }
        .admin-mode .admin-actions { display: block; }
        .admin-btn-del {
            background: rgba(231, 76, 60, 0.9); color: white; border: none;
            width: 25px; height: 25px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        .header-title-block { padding: 5px; cursor: pointer; display: block; }

        .sticky-controls { 
            padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; 
            z-index: 1100; background: var(--glass-bg); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        .app-logo-text { font-family: 'Galada', cursive; font-size: 22px; color: var(--primary-color); margin-left: 10px; }
        .icon-btn { cursor: pointer; font-size: 18px; background: none; border: none; color: var(--text-color); position: relative; padding: 8px; transition: transform 0.2s; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { background: rgba(0,0,0,0.05); }
        .badge { position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; display: none; justify-content: center; align-items: center; font-weight: bold; border: 2px solid var(--bg-color); }
        .badge.active { display: flex; }

        /* Search & Filter */
        .search-wrapper { position: relative; margin-bottom: 15px; }
        #searchBar { width: 100%; padding: 12px 40px 12px 20px; border-radius: 30px; border: 1px solid var(--border-color); background: var(--glass-bg); color: var(--text-color); outline: none; box-sizing: border-box; font-size: 15px; box-shadow: var(--shadow-soft); transition: 0.3s; }
        #searchBar:focus { box-shadow: 0 4px 15px rgba(24, 119, 242, 0.2); border-color: var(--primary-color); }
        .search-clear { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--secondary-text); cursor: pointer; display: none; }

        .category-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; margin-bottom: 10px; }
        .category-tabs::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 8px 18px; border-radius: 20px; border: 1px solid transparent; background: var(--glass-bg); color: var(--text-color); cursor: pointer; font-size: 14px; transition: 0.3s; font-family: inherit; font-weight: 500; box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 6px; }
        .cat-btn.active { background: var(--gradient-primary); color: white; border: none; box-shadow: 0 4px 12px rgba(24, 119, 242, 0.4); }

        /* Post Details */
        .pinned-badge { position: absolute; top: 15px; right: 15px; color: #e74c3c; font-size: 16px; transform: rotate(45deg); z-index: 2; }
        
        .author-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar-circle { width: 34px; height: 34px; background: #e4e6eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; border: 1px solid var(--border-color);}
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .author-text h4 { margin: 0; font-size: 14px; font-weight: 700; }
        .post-meta { font-size: 11px; color: var(--secondary-text); display: flex; align-items: center; gap: 5px; }

        .post-title { font-size: 17px; margin: 0 0 8px 0; font-weight: 700; line-height: 1.35; color: var(--text-color); }
        .post-img-container { width: 100%; border-radius: 12px; overflow: hidden; margin: 8px 0; line-height: 0; }
        .post-img { width: 100%; display: block; object-fit: cover; }
        .content-preview { font-size: 14px; line-height: 1.6; color: var(--text-color); overflow: hidden; position: relative; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; margin-bottom: 10px; }
        
        .interaction-bar { display: flex; justify-content: space-between; border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: auto; position: relative; }
        .action-btn-wrapper { position: relative; display: inline-block; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); font-size: 14px; display: flex; align-items: center; gap: 6px; padding: 5px; transition: 0.2s; user-select: none; }
        .action-btn.liked { color: #e74c3c; }
        .action-btn:hover { color: var(--primary-color); }

        /* Follow System UI */
        .follow-btn {
            font-size: 10px; padding: 3px 8px; border-radius: 12px; border: 1px solid var(--primary-color);
            background: none; color: var(--primary-color); cursor: pointer; margin-left: 8px; font-weight: 600;
        }
        .follow-btn.following { background: var(--primary-color); color: white; }

        /* Pagination UI */
        #loadMoreContainer { text-align: center; margin: 20px 0; padding-bottom: 80px; }
        .load-more-btn {
            padding: 10px 25px; border-radius: 30px; border: none; background: var(--glass-bg); 
            color: var(--secondary-text); font-weight: 600; cursor: pointer; box-shadow: var(--shadow-soft);
        }

        /* Detail View */
        #detailView {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            overflow-y: auto; display: none; flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .detail-header {
            position: sticky; top: 0; left: 0; width: 100%;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            padding: 10px 15px; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--border-color); z-index: 2001;
        }
        .detail-content { padding: 20px; padding-bottom: 100px; max-width: 800px; margin: 0 auto; }
        .detail-title { font-size: 24px; font-weight: 800; line-height: 1.3; margin-bottom: 15px; }
        .detail-img { width: 100%; border-radius: 15px; margin-bottom: 20px; box-shadow: var(--shadow-soft); }
        .detail-text { font-size: 18px; line-height: 1.8; color: var(--text-color); }
        .detail-bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--glass-bg); padding: 10px 0;
            display: flex; justify-content: space-around;
            border-top: 1px solid var(--border-color); backdrop-filter: blur(10px);
        }
        .detail-action { font-size: 20px; display: flex; flex-direction: column; align-items: center; color: var(--secondary-text); background: none; border: none; }

        /* Bottom Nav */
        .bottom-nav { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 1500; padding: 0 5px; box-sizing: border-box; 
            border-radius: 35px; border: var(--glass-border); background: var(--glass-bg); backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-nav.nav-hidden { transform: translate(-50%, 150%); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text); background: none; border: none; font-size: 10px; cursor: pointer; width: 60px; padding: 5px 0; transition: all 0.3s;}
        .nav-item i { font-size: 20px; margin-bottom: 5px; transition: 0.3s; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); font-weight: 600; }
        .nav-center-btn { background: var(--gradient-primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transform: translateY(-5px); box-shadow: 0 8px 20px rgba(24, 119, 242, 0.4); }

        /* Profile & Edit */
        #profileView { display: none; padding-bottom: 20px; }
        .profile-cover {
            height: 160px; width: 100%; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 0 0 25px 25px; position: relative; margin-bottom: 50px;
            box-shadow: var(--shadow-soft); background-size: cover; background-position: center;
        }
        .profile-pic-wrapper {
            position: absolute; bottom: -45px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 100px; border-radius: 50%; padding: 4px;
            background: var(--bg-color);
        }
        .profile-pic-large { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }
        .edit-fab { position: absolute; bottom: 0; right: 0; background: var(--text-color); color: var(--bg-color); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-color); cursor: pointer; font-size: 12px; }
        .profile-info { text-align: center; padding: 0 20px; margin-bottom: 20px; }
        .profile-name { font-size: 22px; font-weight: 700; margin: 0; color: var(--text-color); }
        .profile-bio { font-size: 14px; color: var(--secondary-text); margin: 5px 0 0; max-width: 400px; margin: 5px auto; }
        .profile-stats-grid { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--glass-bg); padding: 10px 20px; border-radius: 12px; text-align: center; box-shadow: var(--shadow-soft); border: var(--glass-border); min-width: 80px; }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--primary-color); display: block; }

        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(4px);
        }
        .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        .sheet-content {
            position: fixed; bottom: 0; left: 0; width: 100%;
            max-height: 85vh; background: var(--sheet-bg);
            border-radius: 25px 25px 0 0; z-index: 2001;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .bottom-sheet-overlay.active .sheet-content { transform: translateY(0); }
        .sheet-drag-handle { width: 40px; height: 4px; background: rgba(0,0,0,0.1); border-radius: 10px; margin: 12px auto; flex-shrink: 0; }
        .sheet-body { overflow-y: auto; padding: 0 20px 20px 20px; flex: 1; }

        /* Comments & Notification Styles */
        .comment-item { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .comment-author { font-weight: bold; font-size: 13px; }
        .comment-text { font-size: 14px; color: var(--text-color); }
        .reply-box { margin-left: 20px; border-left: 2px solid var(--border-color); padding-left: 10px; margin-top: 5px; }
        .c-action-bar { display: flex; gap: 15px; margin-top: 5px; font-size: 11px; color: var(--secondary-text); }
        .c-act-btn { cursor: pointer; }
        
        .notif-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .notif-item.unread { background: rgba(24, 119, 242, 0.05); }
        .notif-text { font-size: 13px; color: var(--text-color); }
        .notif-time { font-size: 10px; color: var(--secondary-text); }

        /* Loaders & Uploads */
        .upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); border-radius: 50%;
            display: none; align-items: center; justify-content: center; flex-direction: column;
            color: white; font-size: 10px; font-weight: bold; z-index: 10;
        }
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 2px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General UI Elements */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; background: rgba(0,0,0,0.02); color: var(--text-color); font-family: inherit; box-sizing: border-box; outline: none; }
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; font-size: 15px; margin-top: 10px; }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 5px 15px rgba(24, 119, 242, 0.3); }

        /* Modal Overlays */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2100; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-color); padding: 20px; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border: 1px solid var(--border-color); }
        
        #quote-capture-area { position:fixed; left:-9999px; width:1080px; height: 1080px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-size: cover; background-position: center; border-radius:0; background-color: #333; }
        
        /* Toast */
        .toast-box { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 8px; }
        .toast-box.show { opacity: 1; }

        .editor-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.02); }
        .editor-toolbar { display: flex; gap: 5px; padding: 8px; background: rgba(0,0,0,0.05); border-bottom: 1px solid var(--border-color); }
        .rich-editor { min-height: 150px; padding: 12px; outline: none; color: var(--text-color); overflow-y: auto; max-height: 300px; line-height: 1.5; }

        /* Login Required Modal */
        .google-btn { background:#4285F4; color:white; display:flex; align-items:center; justify-content:center; gap:10px; width:100%; padding:12px; border:none; border-radius:30px; font-weight:bold; cursor:pointer; font-size:15px; box-shadow:0 4px 10px rgba(66,133,244,0.3); }

        /* Skeleton */
        .skeleton-card { background: var(--glass-bg); border: var(--glass-border); padding: 15px; margin-bottom: 15px; border-radius: 20px; break-inside: avoid; display: inline-block; width: 100%; box-sizing: border-box; }
        .skeleton { background: var(--shimmer-bg); background: linear-gradient(90deg, var(--shimmer-bg) 0%, var(--shimmer-highlight) 50%, var(--shimmer-bg) 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .sk-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .sk-avatar { width: 34px; height: 34px; border-radius: 50%; }
        .sk-info { display: flex; flex-direction: column; gap: 5px; }
        .sk-name { width: 100px; height: 12px; }
        .sk-date { width: 60px; height: 10px; }
        .sk-img { width: 100%; height: 150px; border-radius: 12px; margin-bottom: 15px; }
        .sk-title { width: 80%; height: 18px; margin-bottom: 10px; }
        .sk-line { width: 100%; height: 12px; margin-bottom: 6px; }

        /* Reaction Bar */
        .reaction-bar { position: absolute; bottom: 40px; left: -10px; background: var(--sheet-bg); border-radius: 50px; padding: 5px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: none; gap: 8px; z-index: 100; border: 1px solid var(--border-color); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .reaction-bar.show { display: flex; }
        .reaction-icon { font-size: 22px; cursor: pointer; transition: transform 0.2s; display: inline-block; }
        .reaction-icon:hover { transform: scale(1.4) translateY(-5px); }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .r-love { color: #e74c3c; } .r-haha { color: #f7b928; } .r-sad { color: #f7b928; } .r-angry { color: #e74c3c; } .r-care { color: #e6683c; }
    </style>
</head>
<body>

    <!-- Reading Progress -->
    <div id="readingProgress"></div>
    <div id="toast" class="toast-box"><i class="fas fa-info-circle"></i> <span id="toastMsg">Notification</span></div>

    <!-- Sticky Header -->
    <div class="sticky-controls" id="mainHeader">
        <div style="display:flex; align-items:center;">
            <div class="header-title-block" onclick="handleSecretTap()">
                <span class="app-logo-text"><i class="fas fa-feather-alt"></i> মুক্তলিপি</span>
            </div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="icon-btn" onclick="toggleFont()" title="ফন্ট"><i class="fas fa-font"></i></button>
            <button class="icon-btn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            <button class="icon-btn" onclick="openNotifications()">
                <i class="fas fa-bell"></i>
                <span id="notifBadge" class="badge">0</span>
            </button>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content glass-panel" style="width:300px; text-align:center;">
            <i class="fas fa-lock" style="font-size:40px; color:var(--primary-color); margin-bottom:15px;"></i>
            <h3 style="margin:0 0 10px 0;">লগিন প্রয়োজন</h3>
            <p style="color:var(--secondary-text); font-size:14px; margin-bottom:20px;">এই কাজটি করতে হলে আপনাকে লগিন করতে হবে।</p>
            <button class="google-btn" onclick="performLogin()"><i class="fab fa-google"></i> গুগল দিয়ে লগিন</button>
            <button class="btn" onclick="document.getElementById('loginModal').style.display='none'" style="background:transparent; color:var(--secondary-text);">বন্ধ করুন</button>
        </div>
    </div>

    <!-- POST DETAIL VIEW -->
    <div id="detailView">
        <div class="detail-header">
            <button onclick="closeDetailView()" style="background:none; border:none; font-size:20px; color:var(--text-color); cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="avatar-circle" style="width:30px; height:30px;"><img id="detailAuthorImg" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"></div>
                <div style="font-size:14px; font-weight:700;" id="detailAuthorName">Author</div>
            </div>
        </div>
        
        <div class="detail-content">
            <img id="detailMainImg" class="detail-img" src="" style="display:none;">
            <h1 id="detailTitle" class="detail-title">Title</h1>
            <div style="font-size:12px; color:var(--secondary-text); margin-bottom:15px;" id="detailDate">Date</div>
            <div id="detailBody" class="detail-text"></div>
        </div>

        <div class="detail-bottom-bar">
            <button class="detail-action" id="detailLikeBtn" onclick=""><i class="far fa-heart"></i> <span id="detailLikeCount" style="font-size:10px; margin-top:3px;">0</span></button>
            <button class="detail-action" id="detailCommentBtn" onclick=""><i class="far fa-comment"></i> <span style="font-size:10px; margin-top:3px;">মন্তব্য</span></button>
            <button class="detail-action" id="detailSaveBtn" onclick=""><i class="far fa-bookmark"></i> <span style="font-size:10px; margin-top:3px;">সেভ</span></button>
            <button class="detail-action" id="detailShareBtn" onclick=""><i class="fas fa-share-nodes"></i> <span style="font-size:10px; margin-top:3px;">শেয়ার</span></button>
        </div>
    </div>

    <div class="container">
        <!-- Home View -->
        <div id="feedView" class="view-section active-view">
            <div class="greeting-section">
                <h1 id="greetingText" class="greeting-text"><i class="fas fa-sun"></i> শুভ সকাল</h1>
                <p id="dateText" class="date-text">আজকের দিনটি আপনার ভালো কাটুক</p>
            </div>

            <div class="search-wrapper">
                <input type="text" id="searchBar" placeholder="লেখা বা লেখক খুঁজুন..." oninput="filterPosts(this.value)">
                <button class="search-clear" id="searchClearBtn" onclick="clearSearch()"><i class="fas fa-times"></i></button>
            </div>

            <div class="category-tabs">
                <button class="cat-btn active" onclick="filterCategory('সব', this)">সব</button>
                <button class="cat-btn" onclick="filterCategory('Following', this)"><i class="fas fa-user-friends"></i> ফলোইং</button>
                <button class="cat-btn" onclick="filterCategory('জনপ্রিয়', this)"><i class="fas fa-fire"></i> জনপ্রিয়</button>
                <button class="cat-btn" onclick="filterCategory('গল্প', this)">গল্প</button>
                <button class="cat-btn" onclick="filterCategory('কবিতা', this)">কবিতা</button>
                <button class="cat-btn" onclick="filterCategory('ডায়েরি', this)">ডায়েরি</button>
                <button class="cat-btn" onclick="filterCategory('ইসলামিক', this)">ইসলামিক</button>
            </div>

            <!-- Feed -->
            <div id="feed" class="masonry-feed"></div>
            
            <!-- Pagination Button -->
            <div id="loadMoreContainer">
                <button id="loadMoreBtn" class="load-more-btn" onclick="loadPosts(true)">আরও দেখুন <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profileView" class="view-section">
            <div class="profile-cover">
                <div class="profile-pic-wrapper">
                    <img id="profilePic" src="" class="profile-pic-large" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                    <div class="edit-fab" onclick="openEditProfileSheet()"><i class="fas fa-pen"></i></div>
                </div>
            </div>
            <div class="profile-info">
                <h2 id="profileNameDisplay" class="profile-name">Name</h2>
                <div id="profileBioDisplay" class="profile-bio">Bio...</div>
            </div>
            <div class="profile-stats-grid">
                <div class="stat-card"><span id="statPosts" class="stat-val">0</span><span class="stat-label" style="font-size:11px;">পোস্ট</span></div>
                <div class="stat-card"><span id="statFollowers" class="stat-val">0</span><span class="stat-label" style="font-size:11px;">ফলোয়ার</span></div>
            </div>
            <div id="profileContentFeed" class="masonry-feed"></div>
            <button class="btn" onclick="logoutFunc()" style="background:rgba(231, 76, 60, 0.1); color:#e74c3c; margin-top:30px;">লগআউট</button>
        </div>
    </div>

    <!-- Floating Dock -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i>হোম</button>
        <button class="nav-item" onclick="navTo('saved', this)"><i class="fas fa-bookmark"></i>সেভড</button>
        <button class="nav-center-btn" onclick="openWriteModal()"><i class="fas fa-pen-nib"></i></button>
        <button class="nav-item" onclick="showToast('শীঘ্রই আসছে')"><i class="fas fa-book"></i>লাইব্রেরি</button>
        <button class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i>প্রোফাইল</button>
    </nav>

    <!-- Bottom Sheet -->
    <div id="universalBottomSheet" class="bottom-sheet-overlay" onclick="closeBottomSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-drag-handle"></div>
            <h3 id="sheetTitle" style="text-align:center; margin:10px 0; font-size:16px;">Title</h3>
            <div id="sheetBody" class="sheet-body"></div>
            <div id="sheetFooter" style="padding:10px 15px; border-top:1px solid var(--border-color); display:none; gap:10px;">
                <input type="text" id="sheetInput" placeholder="মন্তব্য লিখুন...">
                <input type="hidden" id="replyParentId">
                <button id="sheetSendBtn" style="background:var(--primary-color); color:white; border:none; border-radius:8px; width:40px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Sheet -->
    <div id="editProfileSheet" class="bottom-sheet-overlay" onclick="closeEditProfileSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-drag-handle"></div>
            <div class="sheet-body" style="padding-top:10px;">
                <h3 style="margin-top:0; text-align:center;">প্রোফাইল এডিট</h3>
                <div style="display:flex; justify-content:center; margin-bottom:15px; position:relative; width:80px; height:80px; margin:0 auto 15px auto;">
                    <img id="editProfileImgPreview" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
                    <div id="profileLoader" class="upload-overlay"><div class="spinner"></div><span id="profileLoadText">0%</span></div>
                </div>
                <button onclick="document.getElementById('profileImgInput').click()" class="btn" style="background:rgba(0,0,0,0.05); color:var(--text-color); margin-bottom:15px; font-size:13px;">ছবি পরিবর্তন</button>
                <input type="file" id="profileImgInput" hidden accept="image/*">
                <label style="font-size:12px; font-weight:bold;">আপনার নাম</label>
                <input type="text" id="editDisplayName" placeholder="আপনার নাম" style="margin-bottom:10px;">
                <label style="font-size:12px; font-weight:bold;">বায়ো</label>
                <textarea id="editBio" placeholder="আপনার সম্পর্কে..." style="height:80px;"></textarea>
                <button class="btn btn-primary" id="saveProfileBtn">সংরক্ষণ করুন</button>
                <div style="height:20px;"></div>
            </div>
        </div>
    </div>

    <!-- Write Modal -->
    <div id="adminModalWrapper" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">লেখা জমা দিন</h3>
                <button onclick="document.getElementById('adminModalWrapper').style.display='none'" style="background:none; border:none; font-size:20px;"><i class="fas fa-times"></i></button>
            </div>
            <div id="writeFormContainer">
                <input type="text" id="postTitle" placeholder="শিরোনাম" style="margin-top:5px;">
                <select id="postCategory" style="margin-top:10px;">
                    <option value="অন্যান্য">ক্যাটাগরি</option>
                    <option value="গল্প">গল্প</option>
                    <option value="কবিতা">কবিতা</option>
                    <option value="ডায়েরি">ডায়েরি</option>
                    <option value="ইসলামিক">ইসলামিক</option>
                </select>
                <div class="editor-container" style="margin-top:10px;">
                    <div class="editor-toolbar">
                        <button onclick="document.execCommand('bold')"><b>B</b></button>
                        <button onclick="document.execCommand('italic')"><i>I</i></button>
                        <button onclick="const u=prompt('URL');if(u)document.execCommand('createLink',false,u)"><i class="fas fa-link"></i></button>
                    </div>
                    <div id="richEditor" class="rich-editor" contenteditable="true" placeholder="এখানে লিখুন..."></div>
                </div>
                <button onclick="document.getElementById('imgInput').click()" class="btn" style="margin-top:10px; background:rgba(24, 119, 242, 0.1); color:var(--primary-color);">
                    <i class="fas fa-camera"></i> ছবি যোগ করুন
                </button>
                <input type="file" id="imgInput" hidden accept="image/*">
                <input type="hidden" id="postImage">
                <button class="btn btn-primary" id="submitBtn" onclick="handleSubmission()">জমা দিন</button>
            </div>
        </div>
    </div>

    <!-- Hidden Capture -->
    <div id="quote-capture-area">
        <div style="background:rgba(0,0,0,0.6); width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; padding:80px; text-align:center; color:white;">
            <div id="q-text" style="font-family:'Galada'; font-size:55px; line-height:1.6; margin-bottom:40px;"></div>
            <div id="q-author" style="font-family:'Noto Serif Bengali'; font-size:35px; font-weight:bold; color:#f1c40f;"></div>
            <div style="margin-top:60px; border-top:2px solid rgba(255,255,255,0.4); padding-top:20px; font-size:25px; opacity:0.8;">
                <i class="fas fa-feather-alt"></i> মুক্তলিপি ডায়েরি
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove, get, query, orderByChild, limitToLast, endBefore, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const ADMIN_UID = "Pg5ko76Pu8Zf4ja9MMzEJRLDMYs1"; 
        const firebaseConfig = {
            apiKey: "AIzaSyBZtycgadrngON2WEwvIE7ERPYxdkDVfFM",
            authDomain: "muktolipidiary.firebaseapp.com",
            databaseURL: "https://muktolipidiary-default-rtdb.firebaseio.com",
            projectId: "muktolipidiary",
            storageBucket: "muktolipidiary.firebasestorage.app",
            messagingSenderId: "639103995400",
            appId: "1:639103995400:web:13528e51c0e86080770bbd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.allPosts = [];
        window.myFollowing = []; 
        window.currentUser = null;
        let lastLoadedTimestamp = null;
        let isFetching = false;
        
        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if(user) {
                syncUserProfile(user);
                document.getElementById('loginModal').style.display = 'none';
                loadFollowingList();
                listenForNotifications();
                if(document.getElementById('profileView').style.display === 'block') loadProfile();
            }
        });

        window.performLogin = () => signInWithPopup(auth, provider).catch(console.error);
        window.logoutFunc = () => signOut(auth).then(() => window.location.reload());
        window.checkAuth = () => { if(window.currentUser) return true; document.getElementById('loginModal').style.display='flex'; return false; };

        function syncUserProfile(user) {
            get(ref(db, 'users/' + user.uid)).then(s => {
                if(!s.exists()) set(ref(db, 'users/' + user.uid), { displayName: user.displayName, email: user.email, photoURL: user.photoURL, bio: "হাই!", joinDate: Date.now() });
            });
        }

        // --- 1. PAGINATION & FEED ---
        // Replacing global onValue with specific fetch logic
        window.loadPosts = function(isNextPage = false) {
            if(isFetching) return;
            isFetching = true;
            document.getElementById('loadMoreBtn').innerText = "লোড হচ্ছে...";

            let q;
            if(isNextPage && lastLoadedTimestamp) {
                q = query(ref(db, 'posts'), orderByChild('timestamp'), endBefore(lastLoadedTimestamp), limitToLast(10));
            } else {
                q = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(10));
                if(!isNextPage) window.allPosts = []; // Reset on refresh
            }

            get(q).then(snapshot => {
                const data = snapshot.val();
                if(data) {
                    const postsArr = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                    // RDB returns ascending, reverse for newest first
                    postsArr.sort((a, b) => b.timestamp - a.timestamp);
                    
                    lastLoadedTimestamp = postsArr[postsArr.length - 1].timestamp;
                    window.allPosts = [...window.allPosts, ...postsArr];
                    
                    renderFeed(window.allPosts, 'feed', isNextPage); // Append if next page
                } else {
                    if(isNextPage) showToast("আর কোনো পোস্ট নেই");
                    else document.getElementById('feed').innerHTML = '<div style="text-align:center;padding:50px;">কোনো পোস্ট নেই</div>';
                    document.getElementById('loadMoreBtn').style.display = 'none';
                }
                document.getElementById('loadMoreBtn').innerHTML = 'আরও দেখুন <i class="fas fa-arrow-down"></i>';
                isFetching = false;
            });
        };

        // Initialize Feed
        loadPosts(false);

        // --- RENDER LOGIC ---
        window.renderFeed = function(posts, targetId = 'feed', append = false) {
            const feed = document.getElementById(targetId);
            const isAdmin = window.currentUser?.uid === ADMIN_UID || localStorage.getItem('IS_ADMIN') === 'true';
            
            const html = posts.map(post => {
                // Prevent duplicate rendering if appending
                if(append && document.getElementById(`post-${post.key}`)) return ''; 
                
                const liked = localStorage.getItem('LIKED_' + post.key);
                const isFollowing = window.myFollowing.includes(post.uid);
                
                let followBtnHTML = '';
                if(window.currentUser && post.uid !== window.currentUser.uid) {
                     followBtnHTML = `<button class="follow-btn ${isFollowing?'following':''}" onclick="event.stopPropagation(); toggleFollow('${post.uid}', this)">${isFollowing?'Following':'Follow'}</button>`;
                }

                return `
                <div class="post-card glass-panel ${isAdmin ? 'admin-mode' : ''}" id="post-${post.key}" onclick="openDetailView('${post.key}')">
                    ${post.isPinned ? '<i class="fas fa-thumbtack pinned-badge"></i>' : ''}
                    <div class="admin-actions"><button class="admin-btn-del" onclick="event.stopPropagation(); deletePost('${post.key}')"><i class="fas fa-trash"></i></button></div>
                    
                    <div class="author-info">
                        <div class="avatar-circle"><img src="${post.userImg}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"></div>
                        <div class="author-text">
                            <div style="display:flex; align-items:center;">
                                <h4>${post.author}</h4> ${followBtnHTML}
                            </div>
                            <div class="post-meta"><i class="far fa-clock"></i> ${post.date}</div>
                        </div>
                    </div>

                    ${post.image ? `<div class="post-img-container"><img src="${post.image}" class="post-img" loading="lazy"></div>` : ''}
                    <h2 class="post-title">${post.title}</h2>
                    <div class="content-preview">${post.content.replace(/<[^>]*>/g, '').substring(0, 120)}...</div>

                    <div class="interaction-bar">
                        <div class="action-btn-wrapper">
                            <button class="action-btn ${liked ? 'liked' : ''}" onclick="event.stopPropagation(); handleLike('${post.key}', ${post.likes||0}, this, '${post.uid}')">
                                <i class="${liked ? 'fas' : 'far'} fa-heart" style="${liked?'color:#e74c3c':''}"></i> <span class="count-text">${post.likes||0}</span>
                            </button>
                        </div>
                        <button class="action-btn" onclick="event.stopPropagation(); openCommentsSheet('${post.key}', '${post.uid}');">
                            <i class="far fa-comment"></i> <span>মন্তব্য</span>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); openShareSheet('${post.key}')">
                            <i class="fas fa-share-nodes"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');

            if(append) feed.insertAdjacentHTML('beforeend', html);
            else feed.innerHTML = html;
        };

        // --- 2. USER FOLLOW SYSTEM ---
        function loadFollowingList() {
            if(!window.currentUser) return;
            get(ref(db, `following/${window.currentUser.uid}`)).then(snap => {
                window.myFollowing = snap.exists() ? Object.keys(snap.val()) : [];
            });
        }

        window.toggleFollow = function(targetUid, btn) {
            if(!checkAuth()) return;
            const myUid = window.currentUser.uid;
            const isFollowing = btn.classList.contains('following');

            if(isFollowing) {
                remove(ref(db, `following/${myUid}/${targetUid}`));
                remove(ref(db, `followers/${targetUid}/${myUid}`));
                btn.classList.remove('following');
                btn.innerText = 'Follow';
                window.myFollowing = window.myFollowing.filter(id => id !== targetUid);
            } else {
                update(ref(db, `following/${myUid}`), { [targetUid]: true });
                update(ref(db, `followers/${targetUid}`), { [myUid]: true });
                sendNotification(targetUid, 'follow', 'আপনাকে ফলো করছেন');
                btn.classList.add('following');
                btn.innerText = 'Following';
                window.myFollowing.push(targetUid);
            }
        };

        // --- 3. NOTIFICATION SYSTEM ---
        function listenForNotifications() {
            onValue(ref(db, `notifications/${window.currentUser.uid}`), snap => {
                const data = snap.val();
                const badge = document.getElementById('notifBadge');
                if(data) {
                    const count = Object.keys(data).length;
                    badge.innerText = count > 9 ? '9+' : count;
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            });
        }

        window.openNotifications = function() {
            if(!checkAuth()) return;
            document.getElementById('sheetTitle').innerText = 'নোটিফিকেশন';
            document.getElementById('sheetFooter').style.display = 'none';
            const body = document.getElementById('sheetBody');
            body.innerHTML = '<div class="spinner" style="margin:20px auto; border-color:#333; border-top-color:transparent;"></div>';
            document.getElementById('universalBottomSheet').classList.add('active');

            // Clear badge on open (optional logic)
            // remove(ref(db, `notifications/${window.currentUser.uid}`)); 

            get(ref(db, `notifications/${window.currentUser.uid}`)).then(snap => {
                const data = snap.val();
                if(!data) {
                    body.innerHTML = '<p style="text-align:center;color:#666;">কোনো নোটিফিকেশন নেই</p>';
                    return;
                }
                const notifs = Object.entries(data).reverse(); // Newest first
                body.innerHTML = notifs.map(([key, n]) => `
                    <div class="notif-item" onclick="handleNotifClick('${n.postId}', '${key}')">
                        <i class="fas fa-${n.type === 'like' ? 'heart' : n.type === 'comment' ? 'comment' : 'user'}" 
                           style="color:${n.type === 'like' ? '#e74c3c' : '#1877f2'}; font-size:18px;"></i>
                        <div>
                            <div class="notif-text"><b>${n.senderName}</b> ${n.text}</div>
                            <div class="notif-time">${new Date(n.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `).join('');
            });
        };

        window.handleNotifClick = (postId, notifKey) => {
            // Remove notification after read
            remove(ref(db, `notifications/${window.currentUser.uid}/${notifKey}`));
            document.getElementById('universalBottomSheet').classList.remove('active');
            if(postId) openDetailView(postId);
            else navTo('profile'); // For follow notifications
        };

        function sendNotification(targetUid, type, text, postId = null) {
            if(!window.currentUser || targetUid === window.currentUser.uid) return;
            push(ref(db, `notifications/${targetUid}`), {
                type, text, postId,
                senderName: window.currentUser.displayName,
                timestamp: Date.now()
            });
        }

        // --- 4. ADVANCED COMMENTS (Replies) ---
        window.openCommentsSheet = function(postKey, postAuthorUid) {
            if(!checkAuth()) return;
            document.getElementById('sheetTitle').innerText = 'মন্তব্য';
            document.getElementById('sheetFooter').style.display = 'flex';
            document.getElementById('sheetInput').value = ''; 
            document.getElementById('sheetInput').placeholder = 'মন্তব্য লিখুন...';
            document.getElementById('replyParentId').value = '';
            
            const btn = document.getElementById('sheetSendBtn');
            // Remove old listeners to prevent duplicates
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', () => {
                const text = document.getElementById('sheetInput').value;
                const parentId = document.getElementById('replyParentId').value;
                if(!text.trim()) return;

                push(ref(db, `comments/${postKey}`), {
                    text, parentId,
                    author: window.currentUser.displayName,
                    uid: window.currentUser.uid,
                    timestamp: Date.now(),
                    likes: 0
                });

                sendNotification(postAuthorUid, 'comment', 'আপনার পোস্টে মন্তব্য করেছেন', postKey);
                document.getElementById('sheetInput').value = '';
                document.getElementById('replyParentId').value = '';
                document.getElementById('sheetInput').placeholder = 'মন্তব্য লিখুন...';
            });

            document.getElementById('universalBottomSheet').classList.add('active');
            
            onValue(ref(db, `comments/${postKey}`), snap => {
                const data = snap.val();
                const container = document.getElementById('sheetBody');
                if(!data) { container.innerHTML = '<p style="text-align:center;color:#999">প্রথম মন্তব্য করুন</p>'; return; }
                
                const allComms = Object.entries(data).map(([k,v]) => ({key:k, ...v}));
                const parents = allComms.filter(c => !c.parentId);
                
                container.innerHTML = parents.map(p => {
                    const children = allComms.filter(c => c.parentId === p.key);
                    return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${p.author}</span>
                            <span style="font-size:10px; color:#999">${new Date(p.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="comment-text">${p.text}</div>
                        <div class="c-action-bar">
                            <span class="c-act-btn" onclick="replyTo('${p.key}', '${p.author}')">Reply</span>
                            <span class="c-act-btn" onclick="likeComment('${postKey}','${p.key}')"><i class="far fa-heart"></i> ${p.likes||0}</span>
                        </div>
                        ${children.map(c => `
                            <div class="reply-box">
                                <div style="font-size:12px; font-weight:bold;">${c.author}</div>
                                <div style="font-size:13px;">${c.text}</div>
                            </div>
                        `).join('')}
                    </div>`;
                }).join('');
            });
        };

        window.replyTo = function(parentId, author) {
            document.getElementById('replyParentId').value = parentId;
            document.getElementById('sheetInput').placeholder = `@${author} এর উত্তর...`;
            document.getElementById('sheetInput').focus();
        };

        window.likeComment = function(postKey, cKey) {
            // Simplified increment, realistically needs user check like posts
            const cRef = ref(db, `comments/${postKey}/${cKey}/likes`);
            get(cRef).then(s => set(cRef, (s.val()||0) + 1));
        };

        // --- FILTERING & SEARCH ---
        window.filterCategory = function(cat, btn) {
            if(btn) { document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            document.getElementById('searchBar').value = '';
            
            // If filtering, we likely need to fetch specific data or filter locally. 
            // For simplicity in single-file app without complex indexing, we filter loaded posts OR specific 'Following' query.
            const feed = document.getElementById('feed');
            const btnLoad = document.getElementById('loadMoreBtn');

            if(cat === 'সব') {
                btnLoad.style.display = 'inline-block';
                window.allPosts = []; lastLoadedTimestamp = null; loadPosts(false); // Reset to standard pagination
            } 
            else if(cat === 'Following') {
                if(!checkAuth()) return;
                btnLoad.style.display = 'none';
                feed.innerHTML = '<div class="spinner" style="margin:20px auto; border-color:#333; border-top-color:transparent;"></div>';
                // Fetch last 50 posts and filter (Client-side join workaround for NoSQL)
                get(query(ref(db, 'posts'), limitToLast(100))).then(s => {
                    if(!s.exists()) { feed.innerHTML='No posts'; return; }
                    const all = Object.entries(s.val()).map(([k,v])=>({key:k, ...v})).sort((a,b)=>b.timestamp-a.timestamp);
                    const followingPosts = all.filter(p => window.myFollowing.includes(p.uid));
                    renderFeed(followingPosts);
                });
            }
            else {
                // Local filter of currently loaded posts for categories
                btnLoad.style.display = 'none'; // Hide load more for simple filters
                const filtered = window.allPosts.filter(p => cat === 'জনপ্রিয়' ? true : p.category === cat);
                if(cat === 'জনপ্রিয়') filtered.sort((a,b) => (b.likes||0) - (a.likes||0));
                renderFeed(filtered);
            }
        };

        window.filterPosts = function(q) {
            q = q.toLowerCase();
            document.getElementById('searchClearBtn').style.display = q ? 'block' : 'none';
            // Search only works on loaded posts in this architecture
            renderFeed(window.allPosts.filter(p => p.title.toLowerCase().includes(q) || p.author.toLowerCase().includes(q)));
        };
        window.clearSearch = () => { document.getElementById('searchBar').value = ''; filterCategory('সব'); };

        // --- CORE ACTIONS ---
        window.handleLike = (key, count, btn, authorUid) => {
            if(!checkAuth()) return;
            const alreadyLiked = localStorage.getItem('LIKED_'+key);
            let newCount = count || 0;
            if (alreadyLiked) {
                newCount = Math.max(0, newCount - 1);
                update(ref(db, 'posts/'+key), {likes: newCount});
                localStorage.removeItem('LIKED_'+key);
                btn.querySelector('i').className = 'far fa-heart';
                btn.querySelector('i').style.color = '';
                btn.classList.remove('liked');
            } else {
                newCount = newCount + 1;
                update(ref(db, 'posts/'+key), {likes: newCount});
                localStorage.setItem('LIKED_'+key, true);
                btn.querySelector('i').className = 'fas fa-heart';
                btn.querySelector('i').style.color = '#e74c3c';
                btn.classList.add('liked');
                sendNotification(authorUid, 'like', 'আপনার পোস্ট লাইক করেছেন', key);
            }
            btn.querySelector('.count-text').innerText = newCount;
        };

        window.handleSubmission = function() {
            if(!checkAuth()) return;
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('richEditor').innerHTML;
            const category = document.getElementById('postCategory').value;
            const img = document.getElementById('postImage').value;
            
            if (!title || !document.getElementById('richEditor').innerText.trim()) return showToast('❌ সব তথ্য দিন');

            const postData = {
                title, content, category, image: img,
                date: new Date().toLocaleDateString('bn-BD'),
                timestamp: Date.now(),
                author: window.currentUser.displayName,
                userImg: window.currentUser.photoURL,
                uid: window.currentUser.uid,
                likes: 0
            };

            push(ref(db, 'posts'), postData).then(() => {
                showToast("পোস্ট করা হয়েছে ✅");
                document.getElementById('adminModalWrapper').style.display='none';
                window.allPosts = []; lastLoadedTimestamp = null; loadPosts(false); // Refresh
            });
        };

        // --- IMAGE UPLOAD (ImgBB) ---
        document.getElementById('imgInput').addEventListener('change', function() {
            if(!this.files[0]) return;
            const btn = this.previousElementSibling; btn.innerText = "আপলোড হচ্ছে...";
            const fd = new FormData(); fd.append('image', this.files[0]);
            fetch('https://api.imgbb.com/1/upload?key=d34410bcea20d900a8a8bcc3068ac081', {method:'POST', body:fd})
                .then(r=>r.json()).then(d => {
                    document.getElementById('postImage').value = d.data.url;
                    btn.innerText = "✅ যুক্ত হয়েছে"; btn.style.color = "green";
                });
        });

        // --- PROFILE LOADING ---
        window.loadProfile = function() {
            if(!window.currentUser) return;
            get(ref(db, 'users/' + window.currentUser.uid)).then(s => {
                const d = s.val();
                document.getElementById('profileNameDisplay').innerText = d.displayName;
                document.getElementById('profileBioDisplay').innerText = d.bio || '';
                document.getElementById('profilePic').src = d.photoURL;
                // Stats
                const myPosts = window.allPosts.filter(p => p.uid === window.currentUser.uid);
                document.getElementById('statPosts').innerText = myPosts.length;
                get(ref(db, `followers/${window.currentUser.uid}`)).then(fs => 
                    document.getElementById('statFollowers').innerText = fs.exists() ? Object.keys(fs.val()).length : 0
                );
                // Load My Posts
                renderFeed(myPosts, 'profileContentFeed');
            });
        };
        
        window.openEditProfileSheet = () => document.getElementById('editProfileSheet').classList.add('active');
        document.getElementById('saveProfileBtn').addEventListener('click', () => {
             updateProfile(auth.currentUser, { displayName: document.getElementById('editDisplayName').value })
             .then(() => update(ref(db, 'users/'+window.currentUser.uid), {
                 displayName: document.getElementById('editDisplayName').value,
                 bio: document.getElementById('editBio').value
             })).then(() => { showToast("আপডেট হয়েছে"); document.getElementById('editProfileSheet').classList.remove('active'); loadProfile(); });
        });

        // --- MISC UTILS ---
        window.openDetailView = (key) => {
            const p = window.allPosts.find(x => x.key === key);
            if(!p) return;
            document.getElementById('detailTitle').innerText = p.title;
            document.getElementById('detailBody').innerHTML = p.content;
            document.getElementById('detailAuthorName').innerText = p.author;
            document.getElementById('detailAuthorImg').src = p.userImg;
            document.getElementById('detailMainImg').src = p.image || '';
            document.getElementById('detailMainImg').style.display = p.image ? 'block' : 'none';
            document.getElementById('detailLikeCount').innerText = p.likes;
            
            // Rebind detail buttons
            document.getElementById('detailLikeBtn').onclick = function() { handleLike(key, p.likes, this, p.uid); };
            document.getElementById('detailCommentBtn').onclick = function() { openCommentsSheet(key, p.uid); };
            
            document.getElementById('detailView').style.display = 'flex';
        };
        window.closeDetailView = () => document.getElementById('detailView').style.display = 'none';
        
        window.handleSecretTap = function() {
            if(window.currentUser?.uid === ADMIN_UID) {
                localStorage.setItem('IS_ADMIN', 'true');
                showToast("Admin Mode ON");
                renderFeed(window.allPosts); // Re-render to show trash cans
            }
        };
        
        window.deletePost = (key) => {
            if(confirm("Delete?")) remove(ref(db, 'posts/'+key)).then(()=> {
                document.getElementById('post-'+key).remove();
                showToast("Deleted");
            });
        };

        window.showToast = (m) => { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
        window.navTo = (p, btn) => {
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); btn?.classList.add('active');
            document.querySelectorAll('.view-section').forEach(v=>v.style.display='none');
            if(p==='home') document.getElementById('feedView').style.display='block';
            if(p==='profile') { if(checkAuth()){ document.getElementById('profileView').style.display='block'; loadProfile(); }}
        };
        window.closeBottomSheet = (e) => { if(e.target===e.currentTarget) document.getElementById('universalBottomSheet').classList.remove('active'); };
        window.closeEditProfileSheet = (e) => { if(e.target===e.currentTarget) document.getElementById('editProfileSheet').classList.remove('active'); };
        window.toggleFont = () => { const f = ["'Hind Siliguri', sans-serif", "'Noto Serif Bengali', serif", "'Galada', cursive"]; let c=getComputedStyle(document.body).fontFamily.replace(/"/g,""); let n = f[(f.indexOf(c)+1)%3]; document.documentElement.style.setProperty('--current-font', n); };
        window.toggleTheme = () => document.body.classList.toggle('dark-theme');
        
        // Scroll Progress
        window.onscroll = () => document.getElementById("readingProgress").style.width = (window.scrollY / (document.body.scrollHeight - window.innerHeight) * 100) + "%";

    </script>
</body>
</html>