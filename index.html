<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø ‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</title>

    <!-- PWA & Meta -->
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="‡¶Æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶•‡¶æ, ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≠‡¶æ‡¶∑‡¶æ‡ßü- ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø ‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Galada&family=Hind+Siliguri:wght@300;400;500;600;700&family=Noto+Serif+Bengali:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
          appId: "d2470015-4ed1-4274-96bd-1654f86cb54a",
          allowLocalhostAsSecureOrigin: true,
          notifyButton: { enable: true },
          prompts: [{ type: "slidedown", autoPrompt: true, text: { actionMessage: "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßá‡¶§‡ßá ‡¶ö‡¶æ‡¶®?", acceptButton: "‡¶π‡ßç‡¶Ø‡¶æ‡¶Å", cancelButton: "‡¶™‡¶∞‡ßá" } }]
        });
      });
    </script>

    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            /* Light Theme */
            --bg-color: #f0f2f5;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --sheet-bg: #ffffff;
            --text-color: #1c1e21;
            --secondary-text: #65676b;
            --primary-color: #2980b9;
            --accent-gradient: linear-gradient(135deg, #2980b9 0%, #6dd5fa 100%);
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --shadow-card: 0 4px 12px rgba(0,0,0,0.05);
            
            /* Dimensions */
            --radius-card: 20px;
            --radius-btn: 30px;
            --header-height: 65px;
            --nav-height: 70px;
            --transition-speed: 0.3s;
            
            /* Chat Bubbles */
            --msg-sent-bg: #2980b9;
            --msg-sent-text: #fff;
            --msg-rcv-bg: #e4e6eb;
            --msg-rcv-text: #000;
        }

        .dark-theme {
            /* Deep Charcoal Dark Theme */
            --bg-color: #121212;
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --sheet-bg: #1e1e1e;
            --text-color: #e4e6eb;
            --secondary-text: #b0b3b8;
            --primary-color: #5dade2; /* Lighter blue for dark mode */
            --accent-gradient: linear-gradient(135deg, #2980b9 0%, #5dade2 100%);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-soft: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --shadow-card: 0 4px 12px rgba(0,0,0,0.2);
            
            --msg-sent-bg: #2980b9;
            --msg-sent-text: #fff;
            --msg-rcv-bg: #2c2c2c;
            --msg-rcv-text: #e4e6eb;
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0 0 100px 0;
            transition: background var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile if desirable */
        }
        
        /* --- GLASSMORPHISM UTILITY --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-card);
        }

        /* --- LAYOUT COMPONENTS --- */
        .container { max-width: 800px; margin: 0 auto; padding: calc(var(--header-height) + 10px) 15px 10px 15px; min-height: 100vh; }

        /* Sticky Header */
        .sticky-controls {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s;
        }
        .app-logo-text { font-family: 'Galada', cursive; font-size: 24px; color: var(--primary-color); background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Icon Buttons */
        .icon-btn {
            background: rgba(128,128,128,0.1); border: none; color: var(--text-color);
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; font-size: 18px; margin-left: 8px;
            transition: transform 0.2s, background 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); }
        .badge {
            position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white;
            font-size: 10px; width: 16px; height: 16px; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg-color);
        }
        .badge.active { display: flex; }

        /* Stories */
        .stories-container { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .stories-container::-webkit-scrollbar { display: none; }
        .story-item { display: flex; flex-direction: column; align-items: center; min-width: 65px; cursor: pointer; }
        .story-ring {
            width: 58px; height: 58px; border-radius: 50%; padding: 2px;
            background: linear-gradient(var(--bg-color), var(--bg-color)) padding-box, linear-gradient(45deg, #ccc, #999) border-box;
            border: 2px solid transparent; display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .story-ring.active { background: linear-gradient(var(--bg-color), var(--bg-color)) padding-box, var(--accent-gradient) border-box; }
        .story-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .story-name { font-size: 11px; margin-top: 5px; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Search & Tabs */
        .search-wrapper { position: relative; margin: 15px 0; }
        #searchBar {
            width: 100%; padding: 12px 20px; border-radius: var(--radius-btn);
            border: 1px solid var(--border-color); background: rgba(128,128,128,0.05);
            color: var(--text-color); font-size: 15px; outline: none;
            transition: box-shadow 0.3s;
        }
        #searchBar:focus { box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3); border-color: var(--primary-color); }
        .category-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .category-tabs::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 8px 16px; border-radius: var(--radius-btn); border: 1px solid var(--border-color);
            background: var(--glass-bg); color: var(--text-color); white-space: nowrap; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .cat-btn.active { background: var(--accent-gradient); color: white; border-color: transparent; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }

        /* Post Card */
        .masonry-feed { column-count: 1; column-gap: 15px; }
        @media (min-width: 600px) { .masonry-feed { column-count: 2; } }
        
        .post-card {
            break-inside: avoid; margin-bottom: 20px; padding: 15px;
            border-radius: var(--radius-card); position: relative;
            transform: translateZ(0); /* Hardware accel */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:active { transform: scale(0.98); }
        
        .author-info { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .avatar-circle { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; background: #ccc; border: 1px solid var(--border-color); flex-shrink: 0; }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .author-text h4 { margin: 0; font-size: 14px; font-weight: 700; display: flex; align-items: center; }
        .verified-badge { color: var(--primary-color); margin-left: 4px; font-size: 12px; }
        .post-meta { font-size: 11px; color: var(--secondary-text); margin-top: 2px; }
        .pinned-badge { position: absolute; top: 15px; right: 15px; color: #e74c3c; transform: rotate(45deg); font-size: 14px; }
        
        .post-title { font-size: 18px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3; }
        .post-img-container { width: 100%; border-radius: 12px; overflow: hidden; margin: 10px 0; }
        .post-img { width: 100%; display: block; object-fit: cover; }
        .content-preview { font-size: 15px; line-height: 1.6; color: var(--text-color); display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .hashtag { color: var(--primary-color); font-weight: 600; cursor: pointer; }

        .interaction-bar { display: flex; justify-content: space-between; border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 12px; }
        .action-btn { background: none; border: none; color: var(--secondary-text); font-size: 14px; display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
        .action-btn:hover { background: rgba(128,128,128,0.1); }
        .action-btn.liked { color: #e74c3c; }

        /* Reactions */
        .reaction-bar {
            position: absolute; bottom: 45px; left: 10px; background: var(--sheet-bg); border-radius: 30px;
            padding: 8px 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; gap: 10px; z-index: 100;
            border: 1px solid var(--border-color); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .reaction-bar.show { display: flex; }
        .reaction-icon { font-size: 20px; transition: transform 0.2s; cursor: pointer; }
        .reaction-icon:hover { transform: scale(1.3); }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Floating Nav */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px;
            display: flex; justify-content: space-around; align-items: center;
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1500;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-nav.nav-hidden { transform: translate(-50%, 150%); }
        .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: var(--secondary-text); font-size: 10px; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-2px); font-weight: 600; }
        .nav-center-btn {
            width: 50px; height: 50px; border-radius: 50%; background: var(--accent-gradient); color: white;
            border: none; display: flex; align-items: center; justify-content: center; font-size: 20px;
            transform: translateY(-20px); box-shadow: 0 5px 15px rgba(41, 128, 185, 0.4);
            cursor: pointer; transition: transform 0.2s;
        }
        .nav-center-btn:active { transform: translateY(-18px) scale(0.95); }

        /* Modals & Sheets */
        .modal-overlay, .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s; display: flex; justify-content: center; align-items: center;
        }
        .modal-overlay.active, .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: var(--sheet-bg); width: 90%; max-width: 500px; padding: 20px;
            border-radius: var(--radius-card); border: 1px solid var(--border-color);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .sheet-content {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--sheet-bg);
            border-radius: 25px 25px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            max-height: 85vh; display: flex; flex-direction: column; z-index: 2001; border-top: 1px solid var(--glass-border);
        }
        .bottom-sheet-overlay.active .sheet-content { transform: translateY(0); }
        .sheet-drag-handle { width: 40px; height: 4px; background: rgba(128,128,128,0.3); border-radius: 2px; margin: 12px auto; flex-shrink: 0; }
        .sheet-body { padding: 0 20px 20px 20px; overflow-y: auto; flex: 1; }

        /* Full Screen Views */
        #detailView, #chatRoomView {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color);
            z-index: 2100; display: none; flex-direction: column; overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Chat specific */
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; margin-bottom: 5px; position: relative; }
        .msg-sent { background: var(--msg-sent-bg); color: var(--msg-sent-text); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-received { background: var(--msg-rcv-bg); color: var(--msg-rcv-text); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Profile Header */
        .profile-cover { height: 180px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 0 0 25px 25px; position: relative; margin-bottom: 50px; }
        .profile-pic-wrapper { position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); width: 110px; height: 110px; border-radius: 50%; padding: 4px; background: var(--bg-color); }
        .profile-pic-large { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        
        /* Buttons & Forms */
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s; font-size: 15px; margin-top: 10px; }
        .btn-primary { background: var(--accent-gradient); color: white; box-shadow: 0 4px 15px rgba(41, 128, 185, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; background: rgba(128,128,128,0.05); color: var(--text-color); font-family: inherit; outline: none; }
        
        /* Helpers */
        .toast-box {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 13px; z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; backdrop-filter: blur(4px);
        }
        .toast-box.show { opacity: 1; }
        .hidden { display: none !important; }
        
        /* Admin/Reports Specific */
        .pending-item { background: rgba(128,128,128,0.05); padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .pending-actions { display: flex; gap: 8px; margin-top: 8px; }
        .report-reason { color: #e74c3c; font-weight: bold; font-size: 13px; text-transform: uppercase; }

    </style>
</head>
<body>

    <!-- PROGRESS & OFFLINE -->
    <div id="toast" class="toast-box"><i class="fas fa-info-circle"></i> <span id="toastMsg">Notification</span></div>
    
    <!-- HEADER -->
    <div class="sticky-controls" id="mainHeader">
        <div onclick="handleSecretTap()" style="cursor:pointer;">
            <span class="app-logo-text"><i class="fas fa-feather-alt"></i> ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø</span>
        </div>
        <div style="display:flex;">
            <button class="icon-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i></button>
            <button class="icon-btn" onclick="navTo('chatList')">
                <i class="fab fa-facebook-messenger"></i><span id="msgBadge" class="badge">0</span>
            </button>
            <button class="icon-btn" onclick="showNotifications()">
                <i class="fas fa-bell"></i><span id="notifBadge" class="badge">0</span>
            </button>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container" id="mainContainer">
        
        <!-- FEED VIEW -->
        <div id="feedView">
            <div id="storiesBar" class="stories-container"></div>
            
            <div class="search-wrapper">
                <input type="text" id="searchBar" placeholder="‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¨‡¶æ ‡¶≤‡ßá‡¶ñ‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." oninput="filterPosts(this.value)">
            </div>
            
            <div class="category-tabs">
                <button class="cat-btn active" onclick="filterCategory('‡¶∏‡¶¨', this)">‡¶∏‡¶¨</button>
                <button class="cat-btn" onclick="filterCategory('‡¶ú‡¶®‡¶™‡ßç‡¶∞‡¶ø‡ßü', this)"><i class="fas fa-fire"></i> ‡¶ú‡¶®‡¶™‡ßç‡¶∞‡¶ø‡ßü</button>
                <button class="cat-btn" onclick="filterCategory('‡¶ó‡¶≤‡ßç‡¶™', this)">‡¶ó‡¶≤‡ßç‡¶™</button>
                <button class="cat-btn" onclick="filterCategory('‡¶ï‡¶¨‡¶ø‡¶§‡¶æ', this)">‡¶ï‡¶¨‡¶ø‡¶§‡¶æ</button>
                <button class="cat-btn" onclick="filterCategory('‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø', this)">‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</button>
            </div>

            <div id="feed" class="masonry-feed"></div>
            <div id="loadingSpinner" style="text-align:center; padding:20px; color:var(--secondary-text); display:none;"><i class="fas fa-spinner fa-spin"></i> ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profileView" class="hidden">
            <div class="profile-cover" id="profileCover">
                <div class="profile-pic-wrapper">
                    <img id="profilePic" class="profile-pic-large" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                    <div id="profileEditBtn" style="position:absolute; bottom:0; right:0; background:var(--text-color); color:var(--bg-color); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="openEditProfileSheet()"><i class="fas fa-pen" style="font-size:12px;"></i></div>
                </div>
            </div>
            <div style="text-align:center; padding:0 20px;">
                <h2 id="profileNameDisplay" style="margin:5px 0; display:flex; align-items:center; justify-content:center; gap:5px;">Name</h2>
                <div id="profileBioDisplay" style="color:var(--secondary-text); font-size:14px; margin-bottom:15px;">Bio...</div>
                
                <div id="profileActionContainer" style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                    <button id="profileFollowBtn" class="cat-btn" onclick="toggleFollow()" style="display:none;">Follow</button>
                    <button id="profileMsgBtn" class="cat-btn" onclick="initChatFromProfile()" style="display:none;"><i class="fab fa-facebook-messenger"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button>
                    <button id="profileSavedViewBtn" class="cat-btn" onclick="navTo('saved')" style="display:none;"><i class="fas fa-bookmark" style="color:#f39c12"></i> Saved</button>
                </div>
                
                <div class="category-tabs" style="justify-content:center;">
                    <button class="cat-btn active" onclick="switchProfileTab('posts', this)">‡¶≤‡ßá‡¶ñ‡¶æ</button>
                    <button class="cat-btn" onclick="switchProfileTab('drafts', this)">‡¶°‡ßç‡¶∞‡¶æ‡¶´‡¶ü</button>
                </div>
                <div id="profileContentFeed" class="masonry-feed" style="margin-top:20px;"></div>
                <button id="logoutBtn" class="btn" onclick="logoutFunc()" style="background:rgba(231,76,60,0.1); color:#e74c3c; margin:30px 0;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>

        <!-- CHAT LIST VIEW -->
        <div id="chatListView" class="hidden">
            <h2 style="margin:0 0 20px 0;">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h2>
            <div id="chatListContainer"></div>
        </div>

    </div>

    <!-- FLOATING NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i>‡¶π‡ßã‡¶Æ</button>
        <button class="nav-item" onclick="showToast('‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá')"><i class="fas fa-book"></i>‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø</button>
        <button class="nav-center-btn" onclick="openWriteModal()"><i class="fas fa-pen-nib"></i></button>
        <button class="nav-item" onclick="showToast('‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá')"><i class="fas fa-images"></i>‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø</button>
        <button class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
    </nav>

    <!-- DETAIL VIEW MODAL -->
    <div id="detailView">
        <div class="sticky-controls" style="position:sticky;">
            <button onclick="closeDetailView()" style="background:none; border:none; font-size:22px; color:var(--text-color);"><i class="fas fa-arrow-left"></i></button>
            <div style="font-weight:bold;">‡¶™‡ßã‡¶∏‡ßç‡¶ü</div>
            <div style="width:20px;"></div>
        </div>
        <div style="padding:20px; padding-bottom:100px; max-width:800px; margin:0 auto; width:100%;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <img id="detailAuthorImg" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div>
                    <div id="detailAuthorName" style="font-weight:bold; display:flex; align-items:center;"></div>
                    <div id="detailDate" style="font-size:12px; color:var(--secondary-text);"></div>
                </div>
            </div>
            <img id="detailMainImg" src="" style="width:100%; border-radius:15px; margin-bottom:20px; display:none;">
            <h1 id="detailTitle" style="font-size:24px; line-height:1.3; margin-bottom:15px;"></h1>
            <div id="detailBody" style="font-size:17px; line-height:1.8; color:var(--text-color);"></div>
        </div>
        <!-- Bottom Action Bar -->
        <div style="position:fixed; bottom:0; left:0; width:100%; background:var(--glass-bg); backdrop-filter:blur(20px); border-top:1px solid var(--border-color); display:flex; justify-content:space-around; padding:15px;">
            <button class="action-btn" id="detailLikeBtn"><i class="far fa-heart"></i> <span>0</span></button>
            <button class="action-btn" id="detailCommentBtn"><i class="far fa-comment"></i> <span>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</span></button>
            <button class="action-btn" id="detailShareBtn"><i class="fas fa-share-nodes"></i> <span>‡¶∂‡ßá‡ßü‡¶æ‡¶∞</span></button>
            <button class="action-btn" id="detailSaveBtn"><i class="far fa-bookmark"></i> <span>‡¶∏‡ßá‡¶≠</span></button>
        </div>
    </div>

    <!-- CHAT ROOM VIEW -->
    <div id="chatRoomView">
        <div class="sticky-controls" style="position:sticky; justify-content:flex-start; gap:15px;">
            <button onclick="document.getElementById('chatRoomView').style.display='none'" style="background:none; border:none; font-size:20px; color:var(--text-color);"><i class="fas fa-arrow-left"></i></button>
            <img id="chatRoomImg" src="" style="width:35px; height:35px; border-radius:50%;">
            <div>
                <div id="chatRoomName" style="font-weight:bold; font-size:15px;">User</div>
                <div id="chatRoomStatus" style="font-size:11px; color:var(--secondary-text);">Offline</div>
            </div>
        </div>
        <div id="chatMessages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:5px;"></div>
        <div style="padding:10px; background:var(--glass-bg); border-top:1px solid var(--border-color); display:flex; gap:10px; align-items:center;">
            <input type="text" id="chatInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="border-radius:20px; background:rgba(128,128,128,0.1); border:none;">
            <button id="sendMsgBtn" style="background:var(--primary-color); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- UNIVERSAL BOTTOM SHEET (Menu, Comments, Notifs) -->
    <div id="universalBottomSheet" class="bottom-sheet-overlay" onclick="closeBottomSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-drag-handle"></div>
            <h3 id="sheetTitle" style="text-align:center; margin:10px 0;">Title</h3>
            <div id="sheetBody" class="sheet-body"></div>
            <div id="sheetFooter" style="padding:15px; border-top:1px solid var(--border-color); display:none; gap:10px;">
                <input type="text" id="sheetInput" placeholder="‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                <button id="sheetSendBtn" style="background:var(--primary-color); color:white; border:none; width:40px; border-radius:10px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- ADMIN / WRITE MODAL -->
    <div id="adminModalWrapper" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">‡¶≤‡ßá‡¶ñ‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</h3>
                <button onclick="closeAdminModal()" style="background:none; border:none; color:var(--text-color); font-size:20px;"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Admin Tabs -->
            <div id="adminTabs" style="display:none; gap:10px; margin-bottom:15px;">
                <button class="cat-btn active" onclick="switchAdminTab('new')">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü</button>
                <button class="cat-btn" onclick="switchAdminTab('reports')" style="color:#e74c3c; border-color:#e74c3c;">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
            </div>

            <!-- Write Form -->
            <div id="writeFormContainer">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                    <img id="userAvatar" src="" style="width:30px; height:30px; border-radius:50%;">
                    <span id="userName" style="font-weight:600; font-size:13px;">Guest</span>
                </div>
                <input type="text" id="postTitle" placeholder="‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ" style="margin-bottom:10px;">
                <select id="postCategory" style="margin-bottom:10px;">
                    <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="‡¶ó‡¶≤‡ßç‡¶™">‡¶ó‡¶≤‡ßç‡¶™</option>
                    <option value="‡¶ï‡¶¨‡¶ø‡¶§‡¶æ">‡¶ï‡¶¨‡¶ø‡¶§‡¶æ</option>
                    <option value="‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø">‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</option>
                </select>
                <div id="richEditor" contenteditable="true" style="min-height:120px; border:1px solid var(--border-color); border-radius:12px; padding:12px; margin-bottom:10px; background:rgba(128,128,128,0.05);"></div>
                
                <button onclick="document.getElementById('imgInput').click()" class="btn" style="background:rgba(128,128,128,0.1); color:var(--text-color); font-size:13px; margin-top:0;"><i class="fas fa-camera"></i> ‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <input type="file" id="imgInput" hidden accept="image/*">
                <input type="hidden" id="postImage">

                <!-- Admin Only Checkbox -->
                <div id="adminFields" style="display:none; margin-top:10px;">
                    <label style="display:flex; align-items:center; gap:10px; font-size:14px;">
                        <input type="checkbox" id="isPinned" style="width:auto;"> ‡¶™‡¶ø‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü (Admin Only)
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="handleSubmission()">‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <!-- Report List -->
            <div id="reportListContainer" style="display:none; max-height:400px; overflow-y:auto;">
                <div id="reportFeed"></div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content glass-panel" style="text-align:center;">
            <i class="fas fa-lock" style="font-size:40px; color:var(--primary-color); margin-bottom:20px;"></i>
            <h3>‡¶≤‡¶ó‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</h3>
            <p style="color:var(--secondary-text); font-size:14px;">‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ó‡¶ø‡¶® ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§</p>
            <button class="btn btn-primary" onclick="performLogin()"><i class="fab fa-google"></i> ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶ø‡¶®</button>
            <button class="btn" onclick="document.getElementById('loginModal').classList.remove('active')" style="background:transparent; color:var(--secondary-text);">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- HIDDEN CAPTURE AREA -->
    <div id="quote-capture-area" style="position:fixed; left:-9999px; width:1080px; height:1080px; background:#333; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; padding:80px; text-align:center;">
        <div id="q-text" style="font-family:'Galada'; font-size:60px; margin-bottom:40px;"></div>
        <div id="q-author" style="font-size:35px; color:#f1c40f;"></div>
    </div>

    <!-- JS MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove, get, query, orderByKey, limitToLast, endBefore, equalTo, orderByChild, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const ADMIN_UID = "Pg5ko76Pu8Zf4ja9MMzEJRLDMYs1"; 
        const firebaseConfig = { apiKey: "AIzaSyBZtycgadrngON2WEwvIE7ERPYxdkDVfFM", authDomain: "muktolipidiary.firebaseapp.com", databaseURL: "https://muktolipidiary-default-rtdb.firebaseio.com", projectId: "muktolipidiary", storageBucket: "muktolipidiary.firebasestorage.app", messagingSenderId: "639103995400", appId: "1:639103995400:web:13528e51c0e86080770bbd" };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // STATE
        window.currentUser = null;
        window.allPosts = [];
        window.blockedUsers = [];
        window.userVerificationCache = {};
        let activeCategoryFilter = '‡¶∏‡¶¨';
        let lastLoadedKey = null;
        let isLoading = false;
        let currentlyViewingUid = null;

        // AUTH & INIT
        onAuthStateChanged(auth, async (user) => {
            window.currentUser = user;
            if(user) {
                window.OneSignalDeferred.push(OneSignal => OneSignal.login(user.uid));
                fetchBlockedUsers(user.uid);
                syncUserProfile(user);
                initNotificationListener(user.uid);
                initChatListener(user.uid);
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userName').innerText = user.displayName;
                // Admin Button
                if(user.uid === ADMIN_UID) document.getElementById('adminFields').style.display = 'block';
            } else {
                window.OneSignalDeferred.push(OneSignal => OneSignal.logout());
            }
            loadPostsChunk(true);
            loadStoryFeed();
        });

        // UTILS
        window.performLogin = () => signInWithPopup(auth, provider).catch(console.error);
        window.logoutFunc = () => signOut(auth).then(() => window.location.reload());
        window.showToast = (msg) => { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
        window.toggleTheme = () => { document.body.classList.toggle('dark-theme'); localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light'); };
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-theme');
        window.checkAuth = () => { if(window.currentUser) return true; document.getElementById('loginModal').classList.add('active'); return false; };
        
        function getVerifiedBadge(isVerified) { return isVerified ? `<i class="fas fa-check-circle verified-badge"></i>` : ''; }
        function syncUserProfile(user) { get(ref(db, 'users/'+user.uid)).then(s => { if(!s.exists()) set(ref(db, 'users/'+user.uid), { displayName: user.displayName, email: user.email, photoURL: user.photoURL, isVerified: false }); }); }
        function fetchBlockedUsers(uid) { get(ref(db, `users/${uid}/blockedUsers`)).then(s => window.blockedUsers = s.exists() ? Object.keys(s.val()) : []); }

        // FEED LOGIC
        window.loadPostsChunk = function(reset=false) {
            if(isLoading) return;
            isLoading = true;
            if(reset) { window.allPosts = []; lastLoadedKey = null; document.getElementById('feed').innerHTML = ''; document.getElementById('loadingSpinner').style.display = 'block'; }
            
            let postsRef = ref(db, 'posts');
            let q = (activeCategoryFilter !== '‡¶∏‡¶¨') ? query(postsRef, orderByChild('category'), equalTo(activeCategoryFilter), limitToLast(15)) : query(postsRef, orderByKey(), limitToLast(15), (lastLoadedKey ? endBefore(lastLoadedKey) : limitToLast(15)));
            
            get(q).then(async snap => {
                document.getElementById('loadingSpinner').style.display = 'none';
                const data = snap.val();
                if(!data) { isLoading = false; if(reset) document.getElementById('feed').innerHTML = '<div style="text-align:center; padding:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>'; return; }
                
                let newPosts = Object.entries(data).map(([k,v]) => ({key:k, ...v})).reverse();
                newPosts = newPosts.filter(p => !window.blockedUsers.includes(p.uid)); // Filter blocked
                
                // Fetch Verify Cache
                const uids = [...new Set(newPosts.map(p => p.uid))];
                await Promise.all(uids.map(uid => get(ref(db, `users/${uid}/isVerified`)).then(s => window.userVerificationCache[uid] = s.val() === true)));
                
                window.allPosts = [...window.allPosts, ...newPosts];
                if(newPosts.length > 0) lastLoadedKey = newPosts[newPosts.length-1].key;
                renderFeed(window.allPosts);
                isLoading = false;
            });
        };

        window.renderFeed = function(posts, targetId='feed') {
            const container = document.getElementById(targetId);
            container.innerHTML = posts.map(post => {
                const isVerified = window.userVerificationCache[post.uid];
                const badge = getVerifiedBadge(isVerified);
                const isPinned = post.isPinned ? '<i class="fas fa-thumbtack pinned-badge"></i>' : '';
                return `
                <div class="post-card glass-panel" onclick="openDetailView('${post.key}')">
                    ${isPinned}
                    <div style="position:absolute; top:15px; right:15px; z-index:5;" onclick="event.stopPropagation(); openPostMenu('${post.key}', '${post.uid}', '${post.author}')"><i class="fas fa-ellipsis-h" style="color:var(--secondary-text);"></i></div>
                    <div class="author-info" onclick="event.stopPropagation(); viewUserProfile('${post.uid}')">
                        <div class="avatar-circle"><img src="${post.userImg}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"></div>
                        <div class="author-text"><h4>${post.author} ${badge}</h4><div class="post-meta">${post.date}</div></div>
                    </div>
                    ${post.image ? `<div class="post-img-container"><img src="${post.image}" class="post-img" loading="lazy"></div>` : ''}
                    <h3 class="post-title">${post.title}</h3>
                    <div class="content-preview">${post.content.replace(/<[^>]*>/g, '').substring(0,100)}...</div>
                    <div class="interaction-bar">
                        <button class="action-btn"><i class="far fa-heart"></i> ${post.likes||0}</button>
                        <button class="action-btn"><i class="far fa-comment"></i> ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</button>
                        <button class="action-btn"><i class="fas fa-share-nodes"></i> ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
                    </div>
                </div>`;
            }).join('');
        }

        window.filterCategory = (cat, btn) => {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            activeCategoryFilter = cat; loadPostsChunk(true);
        };

        // DETAIL VIEW
        window.openDetailView = function(key) {
            const post = window.allPosts.find(p => p.key === key); if(!post) return;
            document.getElementById('detailTitle').innerText = post.title;
            document.getElementById('detailBody').innerHTML = post.content; // Render HTML
            document.getElementById('detailAuthorName').innerHTML = post.author + getVerifiedBadge(window.userVerificationCache[post.uid]);
            document.getElementById('detailDate').innerText = post.date;
            document.getElementById('detailAuthorImg').src = post.userImg;
            if(post.image) { document.getElementById('detailMainImg').src = post.image; document.getElementById('detailMainImg').style.display='block'; }
            else document.getElementById('detailMainImg').style.display='none';
            
            // Wire buttons
            const likeBtn = document.getElementById('detailLikeBtn');
            likeBtn.onclick = () => handleLike(key, post.likes, likeBtn);
            likeBtn.querySelector('span').innerText = post.likes || 0;
            
            document.getElementById('detailView').style.display = 'flex';
        };
        window.closeDetailView = () => document.getElementById('detailView').style.display = 'none';

        // INTERACTIONS
        window.handleLike = (key, count, btn) => {
            if(!checkAuth()) return;
            const liked = localStorage.getItem('LIKED_'+key);
            let newCount = (count || 0) + (liked ? -1 : 1);
            update(ref(db, 'posts/'+key), {likes: newCount});
            if(liked) localStorage.removeItem('LIKED_'+key); else { localStorage.setItem('LIKED_'+key, true); showToast("Liked ‚ù§Ô∏è"); sendNotification(window.allPosts.find(p=>p.key===key).uid, 'like', key); }
            if(btn) { btn.querySelector('span').innerText = newCount; btn.classList.toggle('liked'); }
        };

        window.openPostMenu = (key, uid, name) => {
            document.getElementById('sheetTitle').innerText = '‡¶Ö‡¶™‡¶∂‡¶®';
            document.getElementById('sheetFooter').style.display = 'none';
            const isMe = window.currentUser && window.currentUser.uid === uid;
            const isAdmin = window.currentUser && window.currentUser.uid === ADMIN_UID;
            let html = `<div class="pending-item" onclick="handleReport('${key}', '${uid}')"><i class="fas fa-exclamation-triangle"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</div>`;
            if(!isMe) html += `<div class="pending-item" onclick="handleBlock('${uid}')"><i class="fas fa-ban"></i> ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (${name})</div>`;
            if(isMe || isAdmin) html += `<div class="pending-item" style="color:#e74c3c" onclick="handleDelete('${key}')"><i class="fas fa-trash"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</div>`;
            document.getElementById('sheetBody').innerHTML = html;
            document.getElementById('universalBottomSheet').classList.add('active');
        };

        window.handleReport = async (postId, reportedUid) => {
            if(!checkAuth()) return;
            document.getElementById('universalBottomSheet').classList.remove('active');
            const { value: reason } = await Swal.fire({ title: '‡¶ï‡¶æ‡¶∞‡¶£?', input: 'select', inputOptions: {'spam':'Spam', 'harassment':'Harassment', 'hate':'Hate Speech'}, showCancelButton:true });
            if(reason) {
                push(ref(db, 'reports'), { postId, reportedUid, reportedBy: window.currentUser.uid, reason, timestamp: Date.now() });
                showToast("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
            }
        };

        window.handleBlock = (uid) => {
            if(!checkAuth()) return;
            update(ref(db, `users/${window.currentUser.uid}/blockedUsers`), { [uid]: true }).then(() => {
                window.blockedUsers.push(uid);
                showToast("‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá üö´");
                loadPostsChunk(true);
                document.getElementById('universalBottomSheet').classList.remove('active');
            });
        };

        window.handleDelete = (key) => {
            if(confirm("‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) remove(ref(db, 'posts/'+key)).then(() => { showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); document.getElementById('universalBottomSheet').classList.remove('active'); loadPostsChunk(true); });
        };

        // ADMIN / WRITE
        window.openWriteModal = () => { if(checkAuth()) { document.getElementById('adminModalWrapper').classList.add('active'); if(window.currentUser.uid === ADMIN_UID) document.getElementById('adminTabs').style.display='flex'; } };
        window.closeAdminModal = () => document.getElementById('adminModalWrapper').classList.remove('active');
        
        window.handleSubmission = () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('richEditor').innerHTML; // HTML Content
            const category = document.getElementById('postCategory').value;
            if(!title || !content) return showToast("‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶® ‚ùå");
            
            const postData = {
                title, content, category,
                date: new Date().toLocaleDateString('bn-BD'),
                timestamp: Date.now(),
                author: window.currentUser.displayName,
                userImg: window.currentUser.photoURL,
                uid: window.currentUser.uid,
                image: document.getElementById('postImage').value || null,
                likes: 0
            };
            
            if(window.currentUser.uid === ADMIN_UID) {
                postData.isPinned = document.getElementById('isPinned').checked;
            }
            
            push(ref(db, 'posts'), postData).then(() => {
                showToast("‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
                closeAdminModal();
                loadPostsChunk(true);
            });
        };

        window.switchAdminTab = (tab) => {
             document.getElementById('writeFormContainer').style.display = tab==='new'?'block':'none';
             document.getElementById('reportListContainer').style.display = tab==='reports'?'block':'none';
             if(tab === 'reports') renderReportList();
        };

        window.renderReportList = () => {
            get(ref(db, 'reports')).then(snap => {
                const data = snap.val();
                if(!data) { document.getElementById('reportFeed').innerHTML = 'No reports'; return; }
                document.getElementById('reportFeed').innerHTML = Object.entries(data).map(([k,v]) => `
                    <div class="pending-item">
                        <div class="report-reason">${v.reason}</div>
                        <div>Reported by: ${v.reportedBy}</div>
                        <div class="pending-actions">
                            <button class="btn" style="padding:5px;" onclick="openDetailView('${v.postId}')">View</button>
                            <button class="btn" style="padding:5px; background:#e74c3c; color:white;" onclick="remove(ref(db, 'posts/${v.postId}')).then(()=>remove(ref(db,'reports/${k}')))">Delete Post</button>
                        </div>
                    </div>`).join('');
            });
        };

        // PROFILE & VERIFICATION
        window.viewUserProfile = (uid) => {
            if(window.blockedUsers.includes(uid)) return showToast("Blocked User");
            document.getElementById('feedView').classList.add('hidden');
            document.getElementById('profileView').classList.remove('hidden');
            currentlyViewingUid = uid;
            
            get(ref(db, 'users/'+uid)).then(snap => {
                const u = snap.val();
                document.getElementById('profileNameDisplay').innerHTML = u.displayName + getVerifiedBadge(u.isVerified);
                document.getElementById('profilePic').src = u.photoURL;
                // Verify Button for Admin
                if(window.currentUser && window.currentUser.uid === ADMIN_UID && uid !== ADMIN_UID) {
                     const btn = document.createElement('button');
                     btn.className = 'cat-btn';
                     btn.innerText = u.isVerified ? 'Unverify' : 'Verify User';
                     btn.onclick = () => update(ref(db, 'users/'+uid), {isVerified: !u.isVerified}).then(()=>viewUserProfile(uid));
                     document.getElementById('profileActionContainer').appendChild(btn);
                }
            });
            // Load user posts...
            get(query(ref(db, 'posts'), orderByChild('uid'), equalTo(uid))).then(snap => {
                const posts = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({key:k,...v})).reverse() : [];
                window.currentUserProfilePosts = posts;
                window.renderFeed(posts, 'profileContentFeed');
            });
        };
        
        window.navTo = (view, btn) => {
             document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
             if(btn) btn.classList.add('active');
             document.getElementById('feedView').classList.add('hidden');
             document.getElementById('profileView').classList.add('hidden');
             document.getElementById('chatListView').classList.add('hidden');
             
             if(view === 'home') document.getElementById('feedView').classList.remove('hidden');
             if(view === 'profile') { if(checkAuth()) viewUserProfile(window.currentUser.uid); }
             if(view === 'chatList') { if(checkAuth()) { document.getElementById('chatListView').classList.remove('hidden'); } }
        };

        // CHAT
        function initChatListener(uid) {
             onValue(ref(db, 'user_chats/'+uid), snap => {
                 const data = snap.val();
                 if(data) {
                     const totalUnseen = Object.values(data).reduce((acc, curr) => acc + (curr.unseenCount||0), 0);
                     const badge = document.getElementById('msgBadge');
                     badge.innerText = totalUnseen;
                     badge.classList.toggle('active', totalUnseen > 0);
                     // Render list...
                     document.getElementById('chatListContainer').innerHTML = Object.entries(data).sort((a,b)=>b[1].timestamp-a[1].timestamp).map(([uid, info]) => `
                        <div class="pending-item" onclick="openChatRoom('${uid}')" style="background:${info.unseenCount?'rgba(41, 128, 185, 0.1)':'var(--glass-bg)'}; cursor:pointer; display:flex; align-items:center; gap:10px;">
                            <div style="font-weight:bold;">${uid.substr(0,5)}..</div>
                            <div>${info.lastMsg}</div>
                        </div>
                     `).join('');
                 }
             });
        }
        window.openChatRoom = (targetUid) => {
             document.getElementById('chatRoomView').style.display = 'flex';
             const chatId = window.currentUser.uid < targetUid ? `${window.currentUser.uid}_${targetUid}` : `${targetUid}_${window.currentUser.uid}`;
             onValue(ref(db, `chats/${chatId}/messages`), snap => {
                 const msgs = snap.val();
                 document.getElementById('chatMessages').innerHTML = msgs ? Object.values(msgs).map(m => `
                    <div class="msg-bubble ${m.sender===window.currentUser.uid ? 'msg-sent' : 'msg-received'}">${m.text}</div>
                 `).join('') : '';
                 document.getElementById('chatMessages').scrollTop = 99999;
             });
             document.getElementById('sendMsgBtn').onclick = () => {
                 const txt = document.getElementById('chatInput').value;
                 if(txt) {
                     push(ref(db, `chats/${chatId}/messages`), { text: txt, sender: window.currentUser.uid, timestamp: Date.now() });
                     update(ref(db, `user_chats/${targetUid}/${window.currentUser.uid}`), { lastMsg: txt, timestamp: Date.now(), unseenCount: 1 }); // Increment logic needed properly
                     document.getElementById('chatInput').value = '';
                 }
             }
        };

        // STORY
        window.loadStoryFeed = () => {
             // Mockup stories logic, replace with real following logic
             const html = window.allPosts.slice(0,5).map(p => `
                <div class="story-item" onclick="viewUserProfile('${p.uid}')">
                    <div class="story-ring active"><img src="${p.userImg}" class="story-img"></div>
                    <span class="story-name">${p.author.split(' ')[0]}</span>
                </div>
             `).join('');
             document.getElementById('storiesBar').innerHTML = html;
        };

        // NOTIFICATIONS
        function initNotificationListener(uid) {
            onValue(ref(db, `notifications/${uid}`), snap => {
                const count = Object.values(snap.val()||{}).filter(n=>!n.read).length;
                const b = document.getElementById('notifBadge');
                b.innerText = count; b.classList.toggle('active', count>0);
            });
        }
        function sendNotification(targetUid, type, postId) {
            if(targetUid !== window.currentUser.uid) push(ref(db, `notifications/${targetUid}`), { type, postId, read: false, timestamp: Date.now() });
        }
        window.showNotifications = () => {
            if(!checkAuth()) return;
            document.getElementById('sheetTitle').innerText = '‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®';
            document.getElementById('universalBottomSheet').classList.add('active');
            get(ref(db, `notifications/${window.currentUser.uid}`)).then(snap => {
                const data = snap.val();
                document.getElementById('sheetBody').innerHTML = data ? Object.entries(data).reverse().map(([k,v]) => `
                    <div class="pending-item" onclick="openDetailView('${v.postId}')">New Interaction on your post</div>
                `).join('') : 'No notifications';
                update(ref(db, `notifications/${window.currentUser.uid}`), null); // Clear for demo
            });
        };
        window.closeBottomSheet = (e) => { if(e.target === e.currentTarget) document.getElementById('universalBottomSheet').classList.remove('active'); };
        
        // ADMIN SECRET
        let taps = 0;
        window.handleSecretTap = () => { taps++; if(taps===5) { taps=0; if(window.currentUser && window.currentUser.uid === ADMIN_UID) { showToast("Admin Mode"); openWriteModal(); } } };

        // INITIAL LOAD
        loadPostsChunk(true);
    </script>
</body>
</html>